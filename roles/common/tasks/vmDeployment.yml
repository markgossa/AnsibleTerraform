- hosts: localhost
  gather_facts: no
  tasks:
    - name: Import variables from vmPrerequisitesVars.yml
      include_vars:
        file: "../vars/vmDeploymentVars.yml"

    - name: Run terraform init
      command: "terraform init ../files"

    - name: Run terraform refresh
      command: "terraform refresh 
      -var subscription_id='{{ subscription_id }}' 
      -var client_id='{{ client_id }}'
      -var tenant_id='{{ tenant_id }}'
      -var client_secret='{{ client_secret }}'
      -var resourceGroupLocation='{{ resourceGroupLocation }}'
      -var resourceGroupName='{{ resourceGroupName }}'
      ../files"

    - name: Run terraform plan
      command: "terraform plan
      -out=terraformplan 
      -var subscription_id='{{ subscription_id }}' 
      -var client_id='{{ client_id }}'
      -var tenant_id='{{ tenant_id }}'
      -var client_secret='{{ client_secret }}'
      -var resourceGroupName='{{ resourceGroupName }}'
      -var resourceGroupLocation='{{ resourceGroupLocation }}'
      -var storageAccountName='{{ storageAccountName }}'
      -var virtualNetworkName='{{ virtualNetworkName }}'
      -var virtualNetworkAddressSpace='{{ virtualNetworkAddressSpace }}'
      -var virtualNetworkDnsServer1='{{ virtualNetworkDnsServer1 }}'
      -var virtualNetworkDnsServer2='{{ virtualNetworkDnsServer2 }}'
      -var subnetName='{{ subnetName }}'
      -var subnetNetworkID='{{ subnetNetworkID }}'
      -var storageAccountTier='{{ storageAccountTier }}'
      -var storageAccountReplicationType='{{ storageAccountReplicationType }}'
      -var vm1Name='{{ vm1Name }}'
      -var vm1IPAddress='{{ vm1IPAddress }}'
      -var vm1Size='{{ vm1Size }}'
      -var vm1DiskCaching='{{ vm1DiskCaching }}'
      -var vm1ManagedDiskType='{{ vm1ManagedDiskType }}'
      -var vmUserName='{{ vmUserName }}'
      -var vmPassword='{{ vmPassword }}'
      -var vmSku='{{ vmSku }}'
      ../files"

    - name: Run terraform apply
      command: "terraform apply -auto-approve terraformplan"