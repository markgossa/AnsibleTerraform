- name: Wait for connection
  wait_for_connection:
    delay: 0
    timeout: 60
    
- name: Install PowerShell modules
  win_psmodule:
    name: '{{ item }}'
    state: present
  with_items:
    - xActiveDirectory
    - xComputerManagement
    - xNetworking
    - xDnsServer

- name: Set WinRM service to automatic
  win_dsc:
    resource_name: Service
    Name: WinRM
    StartupType: Automatic

- name: Install Windows Features
  win_feature:
    name: AD-Domain-Services,RSAT-ADDS-Tools,DNS
    state: present

- name: Join to the domain
  win_dsc:
    resource_name: xComputer
    Name: '{{ hostname }}'
    DomainName: '{{ domain_name }}'
    Credential_username: '{{ DomainAdministratorCredential_username }}'
    Credential_password: '{{ DomainAdministratorCredential_password }}'
  register: JoinDomain

- name: Restart virtual machine
  azure_rm_virtualmachine:
    resource_group: '{{ resourceGroupName }}'
    name: '{{ hostname }}'
    client_id: '{{ client_id }}'
    subscription_id: '{{ subscription_id }}'
    tenant: '{{ tenant_id }}'
    secret: '{{ client_secret }}'
    restarted: yes
  when: JoinDomain.reboot_required == True
  delegate_to: localhost    

- name: Wait for reboot
  wait_for_connection:
    delay: 120
    timeout: 600
  when: JoinDomain.reboot_required == True

- name: Create new domain controller
  win_dsc:
    resource_name: xADDomainController
    DomainName: '{{ domain_name }}'
    SafemodeAdministratorPassword_username: '{{ SafemodeAdministratorPassword_username }}'
    SafemodeAdministratorPassword_password: '{{ SafemodeAdministratorPassword_password }}'
    DomainAdministratorCredential_username: '{{ DomainAdministratorCredential_username }}'
    DomainAdministratorCredential_password: '{{ DomainAdministratorCredential_password }}'
  register: CreateNewDomainController

- name: Restart virtual machine
  azure_rm_virtualmachine:
    resource_group: '{{ resourceGroupName }}'
    name: '{{ hostname }}'
    client_id: '{{ client_id }}'
    subscription_id: '{{ subscription_id }}'
    tenant: '{{ tenant_id }}'
    secret: '{{ client_secret }}'
    restarted: yes
  when: CreateNewDomainController.reboot_required == True
  delegate_to: localhost

- name: Wait for reboot
  wait_for_connection:
    delay: 120
    timeout: 600
  when: CreateNewDomainController.reboot_required == True

- name: Get network adapter name
  win_shell: "(Get-NetAdapter).Name"
  register: interfaceName

- name: Set DNS servers on NIC
  win_dsc:
    resource_name: xDnsServerAddress
    Address: "{{ hostvars[groups['DomainControllers'][1]]['ipAddress'] }},{{ hostvars[groups['DomainControllers'][0]]['ipAddress'] }}"
    AddressFamily: 'IPv4'
    InterfaceAlias: '{{ interfaceName.stdout_lines[0] }}'
